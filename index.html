<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Game Dashboard</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="input-group">
      <input id="newGame" placeholder="Enter game name or ID" />
      <button onclick="addTab()">Add Game</button>
    </div>
    <div id="tabHeader" class="tab-header"></div>
    <div class="content">
      <div class="game-section">
        <h2>Current Price: <span id="price">Loading...</span></h2>
      </div>
      <div class="game-section">
        <h2>Current Players: <span id="players">Loading...</span></h2>

        <button onclick="refreshCurrentGame()" class="refresh-button">
          ðŸ”„ Refresh
        </button>
      </div>
      <div class="game-section">
        <h2>Last Updated:</h2>
        <span id="lastUpdated">Loading...</span>
      </div>
      <div class="game-section">
        <h2>Latest News:</h2>
        <ul id="newsList"></ul>
      </div>
    </div>

    <script>
      // Load games from localStorage or use defaults
      let tabs = JSON.parse(localStorage.getItem("gameTabs")) || [
        { name: "Rumble", id: "890550" },
        { name: "Expedition 33", id: "1903340" },
        { name: "Bloodthief Demo", id: "2941730" },
      ];
      let activeTab = tabs[0]?.name || "Rumble";

      // Save games to localStorage
      function saveTabs() {
        localStorage.setItem("gameTabs", JSON.stringify(tabs));
      }

      // Resolve game ID by name or direct ID
      async function resolveGame(query) {
        if (/^\d+$/.test(query)) {
          return { id: query, name: query };
        } else {
          const res = await fetch(
            `/api/storesearch?term=${encodeURIComponent(query)}&l=english&cc=US`
          );
          const data = await res.json();
          if (data.items && data.items.length) {
            const item = data.items[0];
            return { id: item.id, name: item.name };
          }
          throw new Error("Game not found");
        }
      }

      async function fetchGameData(id) {
        try {
          // Price
          const priceRes = await fetch(
            `/api/appdetails?appids=${id}&l=english`
          );
          const priceJson = await priceRes.json();
          const priceData = priceJson[id]?.data?.price_overview;
          const gameData = priceJson[id]?.data;

          let priceDisplay = "N/A";
          if (priceData) {
            const currentPrice = priceData.final_formatted;
            const originalPrice = priceData.initial_formatted;
            const discountPercent = priceData.discount_percent;

            if (discountPercent > 0) {
              priceDisplay = `
                <span style="text-decoration: line-through; color: #888;">${originalPrice}</span>
                <span style="color: #00ff41; font-weight: bold;">${currentPrice}</span>
                <span style="color: #00ff41; font-size: 0.9em;">(-${discountPercent}%)</span>
              `;
            } else {
              priceDisplay = currentPrice;
            }
          } else if (gameData) {
            // Handle free games, demos, and games without price data
            if (gameData.is_free) {
              priceDisplay =
                '<span style="color: #00ff41; font-weight: bold;">FREE</span>';
            } else if (gameData.type === "demo") {
              priceDisplay =
                '<span style="color: #00ffff; font-weight: bold;">DEMO</span>';
            } else if (
              gameData.release_date &&
              gameData.release_date.coming_soon
            ) {
              priceDisplay =
                '<span style="color: #ff6b35; font-weight: bold;">COMING SOON</span>';
            } else {
              priceDisplay =
                '<span style="color: #b0b0b0;">Price not available</span>';
            }
          }

          document.getElementById("price").innerHTML = priceDisplay;

          // Players
          const playerRes = await fetch(`/api/players?appid=${id}`);
          const playerJson = await playerRes.json();

          // Debug logging
          console.log(`Player count response for ${id}:`, playerJson);

          let playerDisplay = "N/A";
          const response = playerJson.response;

          if (response) {
            // Check if we have a direct player_count (most common format)
            if (
              response.player_count !== undefined &&
              response.player_count !== null
            ) {
              playerDisplay = response.player_count.toLocaleString();
            }
            // Check if result contains the player count (alternative format)
            else if (
              response.result !== undefined &&
              response.result !== null &&
              typeof response.result === "number" &&
              response.result >= 0
            ) {
              playerDisplay = response.result.toLocaleString();
            } else {
              // Handle cases where player count is not available
              if (gameData && gameData.type === "demo") {
                playerDisplay =
                  '<span style="color: #b0b0b0;">Not tracked for demos</span>';
              } else if (
                gameData &&
                gameData.release_date &&
                gameData.release_date.coming_soon
              ) {
                playerDisplay =
                  '<span style="color: #b0b0b0;">Not available (Coming Soon)</span>';
              } else {
                playerDisplay =
                  '<span style="color: #b0b0b0;">Player count not available</span>';
              }
            }
          } else {
            playerDisplay =
              '<span style="color: #b0b0b0;">Player count not available</span>';
          }

          document.getElementById("players").innerHTML = playerDisplay;

          // News
          const newsRes = await fetch(`/api/news?appid=${id}&count=5`);
          const newsJson = await newsRes.json();
          const news = newsJson.appnews?.newsitems || [];

          const newsList = document.getElementById("newsList");
          newsList.innerHTML = news
            .map(
              (item) => `
            <li data-date="${new Date(item.date * 1000).toLocaleDateString()}">
              <a href="${item.url}" target="_blank" rel="noopener noreferrer">
                ${item.title}
              </a>
            </li>
          `
            )
            .join("");

          // Update timestamp
          const now = new Date();
          document.getElementById("lastUpdated").textContent =
            now.toLocaleTimeString();
        } catch (err) {
          console.error(err);
          document.getElementById("price").textContent = "Error";
          document.getElementById("players").textContent = "Error";
          document.getElementById("newsList").innerHTML = "";
        }
      }

      function renderTabs() {
        const tabHeader = document.getElementById("tabHeader");
        tabHeader.innerHTML = tabs
          .map(
            (tab) => `
          <button 
            class="${tab.name === activeTab ? "active" : ""}"
            onclick="setActiveTab('${tab.name}')"
          >
            ${tab.name}
            ${
              tabs.length > 1
                ? `<span class="remove-btn" onclick="removeTab('${tab.name}', event)">Ã—</span>`
                : ""
            }
          </button>
        `
          )
          .join("");
      }

      function setActiveTab(name) {
        activeTab = name;
        renderTabs();
        const game = tabs.find((t) => t.name === name);
        if (game) {
          document.getElementById("price").textContent = "Loading...";
          document.getElementById("players").textContent = "Loading...";
          document.getElementById("newsList").innerHTML = "";
          fetchGameData(game.id);
        }
      }

      function removeTab(name, event) {
        event.stopPropagation(); // Prevent tab activation when clicking remove

        if (tabs.length <= 1) {
          alert("Cannot remove the last tab. Add another game first.");
          return;
        }

        const index = tabs.findIndex((t) => t.name === name);
        if (index !== -1) {
          tabs.splice(index, 1);
          saveTabs();

          // If we removed the active tab, switch to the first available tab
          if (name === activeTab) {
            activeTab = tabs[0].name;
          }

          renderTabs();
          setActiveTab(activeTab);
        }
      }

      function refreshCurrentGame() {
        const game = tabs.find((t) => t.name === activeTab);
        if (game) {
          document.getElementById("price").textContent = "Loading...";
          document.getElementById("players").textContent = "Loading...";
          document.getElementById("newsList").innerHTML = "";
          fetchGameData(game.id);
        }
      }

      async function addTab() {
        const newGameInput = document.getElementById("newGame");
        const query = newGameInput.value.trim();
        if (!query) return;

        try {
          const { id, name } = await resolveGame(query);
          if (tabs.find((t) => t.name === name)) {
            alert("Tab already exists");
            return;
          }
          tabs.push({ name, id });
          saveTabs();
          newGameInput.value = "";
          setActiveTab(name);
        } catch (err) {
          alert(err.message);
        }
      }

      document.getElementById("newGame").addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          addTab();
        }
      });

      // Initial render
      renderTabs();
      if (tabs.length > 0) {
        fetchGameData(tabs[0].id);
      }
    </script>
  </body>
</html>
